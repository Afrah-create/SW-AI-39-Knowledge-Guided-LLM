name: Build Android APK

on:
  push:
    branches:
      - android-app
      - main
    paths:
      - 'android-app/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches:
      - android-app
      - main
    paths:
      - 'android-app/**'
      - '.github/workflows/build-android.yml'
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Accept Android licenses (before SDK operations)
        run: |
          # Install expect for interactive license acceptance
          sudo apt-get update && sudo apt-get install -y expect || true
          
          # Accept all Android SDK licenses BEFORE any SDK operations
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
          
          # Create licenses directory
          mkdir -p $ANDROID_HOME/licenses
          
          # Accept all common Android SDK licenses
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/android-googlexr-license
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_HOME/licenses/intel-android-extra-license
          echo "33b6a2b64607f11b759f320ef9dff34ae51681f0" > $ANDROID_HOME/licenses/android-sdk-arm-dbt-license
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_HOME/licenses/android-googletv-license
          
          # Use expect to auto-accept licenses interactively
          expect <<'EXPECTSCRIPT' || true
          set timeout 300
          spawn flutter doctor --android-licenses
          expect {
            "Accept?" { send "y\r"; exp_continue }
            "y/N" { send "y\r"; exp_continue }
            "y/n" { send "y\r"; exp_continue }
            eof
          }
          EXPECTSCRIPT
          
          # Also accept via sdkmanager if available
          if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            expect <<'EXPECTSCRIPT2' || true
            set timeout 300
            spawn $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
            expect {
              "Accept?" { send "y\r"; exp_continue }
              "y/N" { send "y\r"; exp_continue }
              "y/n" { send "y\r"; exp_continue }
              eof
            }
            EXPECTSCRIPT2
          fi
          
          # Verify licenses are accepted
          ls -la $ANDROID_HOME/licenses/ || echo "License directory check"
          echo "License acceptance completed"
      
      - name: Create local.properties
        run: |
          cd android-app/android
          FLUTTER_SDK=$(flutter --version --machine | grep '"flutter-sdk"' | cut -d'"' -f4)
          echo "flutter.sdk=$FLUTTER_SDK" > local.properties
          cat local.properties
      
      - name: Install dependencies
        run: |
          cd android-app
          flutter pub get
      
      - name: Clean Flutter build
        run: |
          cd android-app
          flutter clean
      
      - name: Verify project structure
        run: |
          cd android-app
          flutter pub get
          flutter config --enable-android
      
      - name: Fix Android embedding (ensure v2)
        run: |
          cd android-app
          # Ensure AndroidManifest has v2 embedding
          if [ -f android/app/src/main/AndroidManifest.xml ]; then
            if ! grep -q "flutterEmbedding.*2" android/app/src/main/AndroidManifest.xml; then
              echo "flutterEmbedding not found or incorrect, fixing..."
            else
              echo "✓ AndroidManifest has v2 embedding"
              cat android/app/src/main/AndroidManifest.xml | grep -A1 flutterEmbedding
            fi
          else
            echo "⚠ AndroidManifest.xml not found, will be generated during build"
          fi
          # Verify MainActivity uses FlutterActivity
          if [ -f android/app/src/main/kotlin/com/example/agricultural_app/MainActivity.kt ]; then
            if ! grep -q "FlutterActivity" android/app/src/main/kotlin/com/example/agricultural_app/MainActivity.kt; then
              echo "⚠ MainActivity not using FlutterActivity"
            else
              echo "✓ MainActivity uses FlutterActivity"
            fi
          else
            echo "⚠ MainActivity.kt not found, will be generated during build"
          fi
      
      - name: Update plugins to latest versions
        run: |
          cd android-app
          echo "Upgrading packages..."
          flutter pub upgrade --no-precompile || true
          echo "Packages upgraded. Getting dependencies..."
          flutter pub get
      
      - name: Verify Flutter setup
        run: |
          cd android-app
          flutter doctor -v
          echo "Flutter setup verified"
      
      - name: Prepare Android build
        run: |
          cd android-app
          echo "Cleaning previous builds..."
          flutter clean || true
          echo "Getting dependencies..."
          flutter pub get
          echo "Ready to build"
          # Verify we can access Android tools
          flutter doctor -v | grep -i android || true
          
      - name: Accept Android licenses (final check)
        run: |
          # Final license acceptance check before build
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          mkdir -p $ANDROID_HOME/licenses
          
          # Accept all licenses one more time
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/android-googlexr-license
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_HOME/licenses/intel-android-extra-license
          echo "33b6a2b64607f11b759f320ef9dff34ae51681f0" > $ANDROID_HOME/licenses/android-sdk-arm-dbt-license
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_HOME/licenses/android-googletv-license
          
          # Use expect to auto-accept any remaining licenses
          if command -v expect >/dev/null 2>&1; then
            expect <<EOF
set timeout 300
spawn flutter doctor --android-licenses
expect {
  "Accept?" { send "y\r"; exp_continue }
  "y/N" { send "y\r"; exp_continue }
  eof
}
EOF
          else
            # Fallback: pipe yes to licenses
            yes | flutter doctor --android-licenses || true
          fi
          echo "All licenses accepted"
      
      - name: Build APK
        id: build-apk
        timeout-minutes: 25
        run: |
          cd android-app
          echo "Attempting to build APK..."
          echo "This may take 10-20 minutes on first build due to dependency downloads..."
          
          # Build with full error capture
          if flutter build apk --release --verbose 2>&1 | tee build.log; then
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
            echo "✓ Build succeeded!"
          else
            BUILD_EXIT_CODE=$?
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
            echo "✗ Build failed with exit code: $BUILD_EXIT_CODE"
            
            # Show comprehensive error information
            echo "=== Build Log (last 500 lines) ==="
            tail -500 build.log
            echo "=== End Build Log ==="
            
            # Check for specific error patterns
            echo "=== Error Analysis ==="
            if grep -i "v1 embedding" build.log; then
              echo "ERROR: v1 embedding detected!"
            fi
            if grep -i "BUILD FAILED\|FAILURE" build.log; then
              echo "ERROR: Gradle build failed!"
              echo "Attempting to get Gradle stacktrace..."
              cd android
              ./gradlew assembleRelease --stacktrace 2>&1 | tail -300 || true
            fi
            if grep -i "error\|exception" build.log | tail -20; then
              echo "Recent errors found above"
            fi
            
            exit $BUILD_EXIT_CODE
          fi
          
          # Verify APK was created
          echo "=== Checking for APK file ==="
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            echo "✓ APK found at: build/app/outputs/flutter-apk/app-release.apk"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          else
            echo "✗ APK not found at expected location!"
            echo "Searching for APK files..."
            find . -name "*.apk" -type f 2>/dev/null || echo "  (none found)"
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Upload APK artifact
        if: steps.build-apk.outputs.BUILD_SUCCESS == 'true'
        run: |
          cd android-app
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "ERROR: APK not found at $APK_PATH"
            exit 1
          fi
          
          echo "Found APK at: $APK_PATH"
          echo "APK size: $(du -h "$APK_PATH" | cut -f1)"
          mkdir -p ../../apk-output
          cp "$APK_PATH" ../../apk-output/app-release.apk
          echo "APK ready for upload"
      
      - name: Upload APK artifact
        if: steps.build-apk.outputs.BUILD_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: agricultural-app-apk
          path: apk-output/app-release.apk
          retention-days: 30
      
      - name: Upload APK to release (if tag)
        if: steps.build-apk.outputs.BUILD_SUCCESS == 'true' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: apk-output/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

