name: Build Android APK

on:
  push:
    branches:
      - android-app
      - main
    paths:
      - 'android-app/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches:
      - android-app
      - main
    paths:
      - 'android-app/**'
      - '.github/workflows/build-android.yml'
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '11'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Accept Android licenses
        run: |
          yes | flutter doctor --android-licenses || true
      
      - name: Create local.properties
        run: |
          cd android-app/android
          FLUTTER_SDK=$(flutter --version --machine | grep '"flutter-sdk"' | cut -d'"' -f4)
          echo "flutter.sdk=$FLUTTER_SDK" > local.properties
          cat local.properties
      
      - name: Install dependencies
        run: |
          cd android-app
          flutter pub get
      
      - name: Clean Flutter build
        run: |
          cd android-app
          flutter clean
      
      - name: Verify project structure
        run: |
          cd android-app
          flutter pub get
          flutter config --enable-android
      
      - name: Fix Android embedding (ensure v2)
        run: |
          cd android-app
          # Ensure AndroidManifest has v2 embedding
          if [ -f android/app/src/main/AndroidManifest.xml ]; then
            if ! grep -q "flutterEmbedding.*2" android/app/src/main/AndroidManifest.xml; then
              echo "flutterEmbedding not found or incorrect, fixing..."
            else
              echo "✓ AndroidManifest has v2 embedding"
              cat android/app/src/main/AndroidManifest.xml | grep -A1 flutterEmbedding
            fi
          else
            echo "⚠ AndroidManifest.xml not found, will be generated during build"
          fi
          # Verify MainActivity uses FlutterActivity
          if [ -f android/app/src/main/kotlin/com/example/agricultural_app/MainActivity.kt ]; then
            if ! grep -q "FlutterActivity" android/app/src/main/kotlin/com/example/agricultural_app/MainActivity.kt; then
              echo "⚠ MainActivity not using FlutterActivity"
            else
              echo "✓ MainActivity uses FlutterActivity"
            fi
          else
            echo "⚠ MainActivity.kt not found, will be generated during build"
          fi
      
      - name: Update plugins to latest versions
        run: |
          cd android-app
          echo "Upgrading packages..."
          flutter pub upgrade --no-precompile || true
          echo "Packages upgraded. Getting dependencies..."
          flutter pub get
      
      - name: Verify Flutter setup
        run: |
          cd android-app
          flutter doctor -v
          echo "Flutter setup verified"
      
      - name: Prepare Android build
        run: |
          cd android-app
          echo "Cleaning previous builds..."
          flutter clean || true
          echo "Getting dependencies..."
          flutter pub get
          echo "Ready to build"
          # Verify we can access Android tools
          flutter doctor -v | grep -i android || true
      
      - name: Build APK
        run: |
          cd android-app
          # Try building with different approaches
          echo "Attempting to build APK..."
          flutter build apk --release --verbose 2>&1 | tee build.log || true
          BUILD_EXIT_CODE=$?
          
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "Build failed with exit code: $BUILD_EXIT_CODE"
            echo "Checking for specific errors..."
            
            if grep -q "v1 embedding" build.log; then
              echo "ERROR: v1 embedding detected. Checking plugins..."
              flutter pub deps | grep -E "(sqflite|path_provider|shared_preferences)" || true
              echo "Trying to update plugins..."
              flutter pub upgrade
              flutter clean
              flutter pub get
              echo "Retrying build..."
              flutter build apk --release
            else
              echo "=== Full build log ==="
              cat build.log
              echo "=== End build log ==="
              
              # Check for Gradle errors
              if grep -q "BUILD FAILED" build.log; then
                echo "Gradle build failed. Checking for specific errors..."
                # Try to get more Gradle details
                cd android
                ./gradlew assembleRelease --stacktrace 2>&1 | tail -100 || true
              fi
              
              exit $BUILD_EXIT_CODE
            fi
          fi
          
          # List the APK location
          echo "APK build complete. Checking output location..."
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found in current directory"
          ls -la build/app/outputs/flutter-apk/ 2>/dev/null || echo "build/app/outputs/flutter-apk/ does not exist"
          
          # Check parent directory (build might be there due to custom build dir)
          if [ -d ../build ]; then
            echo "Checking parent build directory..."
            find ../build -name "*.apk" -type f 2>/dev/null || true
          fi
      
      - name: Find and upload APK artifact
        run: |
          cd android-app
          # Try multiple possible locations
          APK_PATH=""
          
          # Standard Flutter location
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          # Alternative location
          elif [ -f build/app/outputs/apk/release/app-release.apk ]; then
            APK_PATH="build/app/outputs/apk/release/app-release.apk"
          # Check in android/app/build
          elif [ -f android/app/build/outputs/flutter-apk/app-release.apk ]; then
            APK_PATH="android/app/build/outputs/flutter-apk/app-release.apk"
          # Check parent directory (if custom build dir was used)
          elif [ -f ../build/app/outputs/flutter-apk/app-release.apk ]; then
            APK_PATH="../build/app/outputs/flutter-apk/app-release.apk"
          else
            # Find any APK file recursively
            echo "Searching for APK files..."
            APK_PATH=$(find . -name "*.apk" -type f 2>/dev/null | grep -E "(release|app-release)" | head -1)
            if [ -z "$APK_PATH" ]; then
              APK_PATH=$(find .. -name "*.apk" -type f 2>/dev/null | grep -E "(release|app-release)" | head -1)
            fi
          fi
          
          if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
            echo "ERROR: APK file not found!"
            echo "Searched locations:"
            echo "  - build/app/outputs/flutter-apk/app-release.apk"
            echo "  - build/app/outputs/apk/release/app-release.apk"
            echo "  - android/app/build/outputs/flutter-apk/app-release.apk"
            echo "  - ../build/app/outputs/flutter-apk/app-release.apk"
            echo ""
            echo "All APK files found:"
            find . -name "*.apk" -type f 2>/dev/null || echo "  (none found)"
            exit 1
          fi
          
          echo "Found APK at: $APK_PATH"
          echo "APK size: $(du -h "$APK_PATH" | cut -f1)"
          # Copy to a known location for upload
          mkdir -p ../../apk-output
          cp "$APK_PATH" ../../apk-output/app-release.apk
          echo "APK copied to apk-output/app-release.apk"
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: agricultural-app-apk
          path: apk-output/app-release.apk
          retention-days: 30
      
      - name: Upload APK to release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: android-app/build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

