name: Build Android APK

on:
  push:
    branches:
      - android-app
      - main
    paths:
      - 'android-app/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches:
      - android-app
      - main
    paths:
      - 'android-app/**'
      - '.github/workflows/build-android.yml'
  workflow_dispatch:  # Allows manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Accept Android licenses
        uses: android-actions/setup-android@v3
      
      - name: Accept Android licenses (backup method)
        run: |
          # Install expect for interactive license acceptance
          sudo apt-get update && sudo apt-get install -y expect || true
          
          # Accept all Android SDK licenses BEFORE any SDK operations
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
          
          # Create licenses directory
          mkdir -p $ANDROID_HOME/licenses
          
          # Accept all common Android SDK licenses by creating license files
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/android-googlexr-license
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_HOME/licenses/intel-android-extra-license
          echo "33b6a2b64607f11b759f320ef9dff34ae51681f0" > $ANDROID_HOME/licenses/android-sdk-arm-dbt-license
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_HOME/licenses/android-googletv-license
          echo "8403addf88ab4874007e1c1e80a5e619" > $ANDROID_HOME/licenses/android-sdk-license
          
          # Accept licenses using sdkmanager directly (more reliable)
          if [ -f "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            echo "Accepting licenses via sdkmanager..."
            echo 'set timeout 300' > /tmp/accept_sdk.exp
            echo "spawn \"$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager\" --licenses" >> /tmp/accept_sdk.exp
            echo 'expect {' >> /tmp/accept_sdk.exp
            echo '  "Accept?" { send "y\r"; exp_continue }' >> /tmp/accept_sdk.exp
            echo '  "y/N" { send "y\r"; exp_continue }' >> /tmp/accept_sdk.exp
            echo '  "y/n" { send "y\r"; exp_continue }' >> /tmp/accept_sdk.exp
            echo '  "y" { send "y\r"; exp_continue }' >> /tmp/accept_sdk.exp
            echo '  eof' >> /tmp/accept_sdk.exp
            echo '}' >> /tmp/accept_sdk.exp
            timeout 120 expect /tmp/accept_sdk.exp || echo "SDK manager license acceptance completed"
          fi
          
          # Also accept via flutter doctor
          echo "Accepting licenses via flutter doctor..."
          echo 'set timeout 300' > /tmp/accept_flutter.exp
          echo 'spawn flutter doctor --android-licenses' >> /tmp/accept_flutter.exp
          echo 'expect {' >> /tmp/accept_flutter.exp
          echo '  "Accept?" { send "y\r"; exp_continue }' >> /tmp/accept_flutter.exp
          echo '  "y/N" { send "y\r"; exp_continue }' >> /tmp/accept_flutter.exp
          echo '  "y/n" { send "y\r"; exp_continue }' >> /tmp/accept_flutter.exp
          echo '  "y" { send "y\r"; exp_continue }' >> /tmp/accept_flutter.exp
          echo '  eof' >> /tmp/accept_flutter.exp
          echo '}' >> /tmp/accept_flutter.exp
          timeout 120 expect /tmp/accept_flutter.exp || echo "Flutter license acceptance completed"
          
          # Verify licenses are accepted
          echo "=== License files ==="
          ls -la $ANDROID_HOME/licenses/ || echo "License directory check"
          echo "License acceptance step completed"
      
      - name: Create local.properties
        run: |
          cd android-app
          # Get Flutter SDK path - try multiple methods
          FLUTTER_SDK=$(flutter --version --machine | grep '"flutter-sdk"' | cut -d'"' -f4)
          if [ -z "$FLUTTER_SDK" ] || [ ! -d "$FLUTTER_SDK" ]; then
            # Fallback: use which to find flutter binary
            FLUTTER_BIN=$(which flutter)
            if [ -n "$FLUTTER_BIN" ]; then
              FLUTTER_SDK=$(dirname "$FLUTTER_BIN")
              FLUTTER_SDK=$(dirname "$FLUTTER_SDK")
            fi
          fi
          
          # Ensure absolute path
          if [ -n "$FLUTTER_SDK" ]; then
            FLUTTER_SDK=$(cd "$FLUTTER_SDK" && pwd)
          fi
          
          if [ -z "$FLUTTER_SDK" ] || [ ! -d "$FLUTTER_SDK" ]; then
            echo "ERROR: Could not determine Flutter SDK path!"
            echo "Trying to find Flutter..."
            flutter doctor -v
            exit 1
          fi
          
          echo "Flutter SDK path: $FLUTTER_SDK"
          echo "FLUTTER_ROOT=$FLUTTER_SDK" >> $GITHUB_ENV
          
          # Verify Flutter SDK structure
          if [ ! -f "$FLUTTER_SDK/bin/flutter" ]; then
            echo "ERROR: Flutter binary not found at $FLUTTER_SDK/bin/flutter"
            exit 1
          fi
          
          # Create local.properties in android directory with absolute path
          cd android
          echo "flutter.sdk=$FLUTTER_SDK" > local.properties
          echo "Created local.properties:"
          cat local.properties
          
          # Verify file exists and has content
          if [ ! -f "local.properties" ] || [ ! -s "local.properties" ]; then
            echo "ERROR: local.properties not created or empty!"
            exit 1
          fi
      
      - name: Install dependencies
        run: |
          cd android-app
          flutter pub get
      
      - name: Clean Flutter build
        run: |
          cd android-app
          flutter clean
      
      - name: Verify project structure
        run: |
          cd android-app
          flutter pub get
          flutter config --enable-android
          
          # Verify local.properties exists before Gradle operations
          if [ ! -f "android/local.properties" ]; then
            echo "ERROR: local.properties missing! Recreating..."
            FLUTTER_SDK=$(flutter --version --machine | grep '"flutter-sdk"' | cut -d'"' -f4)
            echo "flutter.sdk=$FLUTTER_SDK" > android/local.properties
          fi
          echo "local.properties content:"
          cat android/local.properties || echo "Failed to read local.properties"
      
      - name: Fix Android embedding (ensure v2)
        run: |
          cd android-app
          # Ensure AndroidManifest has v2 embedding
          if [ -f android/app/src/main/AndroidManifest.xml ]; then
            if ! grep -q "flutterEmbedding.*2" android/app/src/main/AndroidManifest.xml; then
              echo "flutterEmbedding not found or incorrect, fixing..."
            else
              echo "✓ AndroidManifest has v2 embedding"
              cat android/app/src/main/AndroidManifest.xml | grep -A1 flutterEmbedding
            fi
          else
            echo "⚠ AndroidManifest.xml not found, will be generated during build"
          fi
          # Verify MainActivity uses FlutterActivity
          if [ -f android/app/src/main/kotlin/com/example/agricultural_app/MainActivity.kt ]; then
            if ! grep -q "FlutterActivity" android/app/src/main/kotlin/com/example/agricultural_app/MainActivity.kt; then
              echo "⚠ MainActivity not using FlutterActivity"
            else
              echo "✓ MainActivity uses FlutterActivity"
            fi
          else
            echo "⚠ MainActivity.kt not found, will be generated during build"
          fi
      
      - name: Update plugins to latest versions
        run: |
          cd android-app
          echo "Upgrading packages..."
          flutter pub upgrade --no-precompile || true
          echo "Packages upgraded. Getting dependencies..."
          flutter pub get
      
      - name: Verify Flutter setup
        run: |
          cd android-app
          flutter doctor -v
          echo "Flutter setup verified"
      
      - name: Prepare Android build
        run: |
          cd android-app
          echo "Cleaning previous builds..."
          flutter clean || true
          echo "Getting dependencies..."
          flutter pub get
          echo "Ready to build"
          # Verify we can access Android tools
          flutter doctor -v | grep -i android || true
          
      - name: Accept Android licenses (final check)
        run: |
          # Final license acceptance check before build
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          mkdir -p $ANDROID_HOME/licenses
          
          # Accept all licenses one more time
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "d975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_HOME/licenses/android-googlexr-license
          echo "601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_HOME/licenses/intel-android-extra-license
          echo "33b6a2b64607f11b759f320ef9dff34ae51681f0" > $ANDROID_HOME/licenses/android-sdk-arm-dbt-license
          echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_HOME/licenses/android-googletv-license
          
          # Use expect to auto-accept any remaining licenses
          if command -v expect >/dev/null 2>&1; then
            echo 'set timeout 300' > /tmp/accept_final.exp
            echo 'spawn flutter doctor --android-licenses' >> /tmp/accept_final.exp
            echo 'expect {' >> /tmp/accept_final.exp
            echo '  "Accept?" { send "y\r"; exp_continue }' >> /tmp/accept_final.exp
            echo '  "y/N" { send "y\r"; exp_continue }' >> /tmp/accept_final.exp
            echo '  "y/n" { send "y\r"; exp_continue }' >> /tmp/accept_final.exp
            echo '  eof' >> /tmp/accept_final.exp
            echo '}' >> /tmp/accept_final.exp
            expect /tmp/accept_final.exp || true
          else
            # Fallback: pipe yes to licenses
            yes | flutter doctor --android-licenses || true
          fi
          echo "All licenses accepted"
      
      - name: Build APK
        id: build-apk
        timeout-minutes: 30
        run: |
          cd android-app
          echo "Attempting to build APK..."
          echo "This may take 10-20 minutes on first build due to dependency downloads..."
          
          # Build with full error capture
          BUILD_SUCCESS=false
          
          # Run build and capture output
          # Filter out harmless "Resource missing" messages (Gradle tries multiple repos)
          # Note: "Resource missing" messages are normal - Gradle checks multiple repositories
          # If a dependency isn't in Google's repo, it tries Maven Central, etc.
          flutter build apk --release --verbose 2>&1 | grep -v "Resource missing" | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}  # Check flutter build exit code, not grep
          
          # Ensure grep didn't fail (it shouldn't, but check just in case)
          if [ ${PIPESTATUS[1]} -ne 0 ] && [ ${PIPESTATUS[1]} -ne 1 ]; then
            echo "Warning: grep filter had unexpected exit code: ${PIPESTATUS[1]}"
          fi
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "Flutter build command completed successfully with exit code: $BUILD_EXIT_CODE"
          else
            echo "Flutter build command failed with exit code: $BUILD_EXIT_CODE"
          fi
          
          # Check if build actually succeeded by looking for APK
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          # Also check alternative locations
          if [ -f "$APK_PATH" ]; then
            BUILD_SUCCESS=true
            echo "BUILD_SUCCESS=true" >> $GITHUB_OUTPUT
            echo "✓ Build succeeded! APK found at: $APK_PATH"
            ls -lh "$APK_PATH"
            du -h "$APK_PATH"
          else
            echo "BUILD_SUCCESS=false" >> $GITHUB_OUTPUT
            echo "✗ Build failed - APK not found at expected location: $APK_PATH"
            
            # Search for APK in other possible locations
            echo "=== Searching for APK files ==="
            find build -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
            find . -name "app-release.apk" -type f 2>/dev/null || echo "No app-release.apk found"
            
            # Show comprehensive error information
            echo "=== Build Log (last 500 lines - most recent first) ==="
            if [ -f build.log ]; then
              tail -500 build.log || cat build.log
            else
              echo "Build log file not found!"
            fi
            echo "=== End Build Log ==="
            
            # Check for specific error patterns
            echo "=== Error Analysis ==="
            if [ -f build.log ]; then
              # Show the END of the log first (where errors usually appear)
              echo "=== Last 100 lines of build log ==="
              tail -100 build.log
              
              # Show the actual error message (usually appears before stack trace)
              echo "=== Actual Error Message ==="
              grep -i "error\|exception\|failed" build.log | grep -v "at org\|at com\|at java\|Caused by\|Resource missing" | tail -30 || echo "No clear error message found"
              
              if grep -i "v1 embedding" build.log; then
                echo "ERROR: v1 embedding detected!"
              fi
              
              # Show BUILD FAILED context with more lines before
              if grep -i "BUILD FAILED\|FAILURE" build.log; then
                echo "=== BUILD FAILED context (last 100 lines before failure) ==="
                grep -B 100 "BUILD FAILED\|FAILURE" build.log | tail -120 || true
              fi
              
              # Show any exceptions with more context
              echo "=== Exceptions Found ==="
              grep -i "exception\|error:" build.log | grep -v "^\[.*Resource missing\|at org\|at com\|at java" | tail -40 || echo "No exceptions found"
              
              if grep -i "timeout\|timed out" build.log; then
                echo "ERROR: Build timeout detected!"
              fi
              
              # Check for file not found errors
              if grep -i "file or directory.*not found\|cannot find\|no such file" build.log; then
                echo "=== File/Directory Not Found Errors ==="
                grep -i "file or directory.*not found\|cannot find\|no such file" build.log | tail -20
              fi
            fi
            
            # Try to get Gradle error details with more context
            if [ -f build.log ] && grep -i "BUILD FAILED\|FAILURE" build.log; then
              echo "=== Attempting to get Gradle stacktrace with more context ==="
              cd android
              echo "Running Gradle assembleRelease with full output..."
              ./gradlew assembleRelease --stacktrace --info 2>&1 | tail -500 || true
              cd ..
            fi
            
            # Show Gradle build directory contents
            echo "=== Checking build directory ==="
            ls -la build/ 2>/dev/null || echo "Build directory not found"
            ls -la build/app/outputs/ 2>/dev/null || echo "Outputs directory not found"
            ls -la build/app/outputs/flutter-apk/ 2>/dev/null || echo "Flutter APK directory not found"
            
            exit 1
          fi
      
      - name: Upload APK artifact
        if: steps.build-apk.outputs.BUILD_SUCCESS == 'true'
        run: |
          cd android-app
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "ERROR: APK not found at $APK_PATH"
            exit 1
          fi
          
          echo "Found APK at: $APK_PATH"
          echo "APK size: $(du -h "$APK_PATH" | cut -f1)"
          mkdir -p ../../apk-output
          cp "$APK_PATH" ../../apk-output/app-release.apk
          echo "APK ready for upload"
      
      - name: Upload APK artifact
        if: steps.build-apk.outputs.BUILD_SUCCESS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: agricultural-app-apk
          path: apk-output/app-release.apk
          retention-days: 30
      
      - name: Upload APK to release (if tag)
        if: steps.build-apk.outputs.BUILD_SUCCESS == 'true' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: apk-output/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

